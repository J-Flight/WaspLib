(*
# Transporter
Responsible for transporting you from one place to another.
This is not meant to be used directly but through {ref}`TRSWalker` WebWalking.
*)

{$DEFINE WL_TRANSPORTER_INCLUDED}
{$INCLUDE_ONCE WaspLib/osrs.simba}

{.$DEFINE WL_TRANSPORTER_DEBUG}

type
  ESpellTeleport = enum(
    HOUSE_INSIDE,
    HOUSE_OUTSIDE,
    KOUREND,
    LASSAR,
    OURANIA,
    RESPAWN,
    VARROCK,
    GRAND_EXCHANGE,
    CAMELOT,
    SEERS,
    KHAZARD,
    FALADOR,
    BARROWS,
    MOONCLAN,
    CEMETERY,
    GHORROCK,
    ARDOUGNE,
    PADDEWWA,
    KHARYRLL,
    ANNAKARL,
    CATHERBY,
    APE_ATOLL_DUNGEON,
    LUMBRIDGE,
    BARBARIAN,
    APE_ATOLL,
    TROLLHEIM,
    MIND_ALTAR,
    WATCHTOWER,
    YANILLE,
    ICE_PLATEU,
    LUNAR_HOME,
    FENKENSTRAINS_CASTLE,
    SALVE_GRAVEYARD,
    ARCEUUS_LIBRARY,
    HARMONY_ISLAND,
    EDGEVILLE_HOME,
    DRAYNOR_MANOR,
    FISHING_GUILD,
    LUMBRIDGE_HOME,
    WEST_ARDOUGNE,
    CARRALLANGAR,
    ARCEUUS_HOME,
    WATERBIRTH,
    SENNTISTEN
  );

  EItemTeleport = enum(
    DUELING_RING, GAMES_NECKLACE, DIGSITE_PENDANT, MYSTIC_CAPE
  );

const
  TELEPORT_COORDINATES: array [ESpellTeleport] of TPoint = [
    [], //HOUSE_INSIDE
    [], //HOUSE_OUTSIDE
    [], //KOUREND
    [], //LASSAR
    [], //OURANIA
    [], //RESPAWN
    [], //VARROCK
    [], //GRAND EXCHANGE
    [], //CAMELOT
    [], //SEERS
    [], //KHAZARD
    [], //FALADOR
    [], //BARROWS
    [], //MOONCLAN
    [], //CEMETERY
    [], //GHORROCK
    [], //ARDOUGNE
    [], //PADDEWWA
    [], //KHARYRLL
    [], //ANNAKARL
    [], //CATHERBY
    [], //APE_ATOLL_DUNGEON
    [], //LUMBRIDGE
    [], //BARBARIAN
    [], //APE_ATOLL
    [], //TROLLHEIM
    [], //MIND_ALTAR
    [], //WATCHTOWER
    [], //YANILLE
    [], //ICE_PLATEU
    [], //LUNAR_HOME
    [], //FENKENSTRAINS_CASTLE
    [], //SALVE_GRAVEYARD
    [], //ARCEUUS_LIBRARY
    [], //HARMONY_ISLAND
    [], //EDGEVILLE_HOME
    [], //DRAYNOR_MANOR
    [], //FISHING_GUILD
    [], //LUMBRIDGE_HOME
    [], //WEST_ARDOUGNE
    [], //CARRALLANGAR
    [], //ARCEUUS_HOME
    [], //WATERBIRTH
    [] //SENNTISTEN
  ];

type
(*
(TTransporter)=
## TTransporter type
Main record responsible for transporting the player from one place to another.
*)
  TTransporter = record
    HomeTeleportTimer: TCountDown;
  end;

function TTransporter.Teleport(spell: ESpellTeleport; pos: TWalkerPositionFunction = nil): Boolean;
var
  t: UInt64;
  option: String;
  magicSpell: ERSSpell;
  hasTimer: Boolean;
begin
  if pos = nil then
    pos := @Map.Position;

  case spell of
    ESpellTeleport.LUMBRIDGE_HOME, ESpellTeleport.EDGEVILLE_HOME,
    ESpellTeleport.LUNAR_HOME, ESpellTeleport.ARCEUUS_HOME:
    begin
      t := 22*TICK;
      hasTimer := True;
    end;
    else t := 6*TICK;
  end;

  case spell of
    ESpellTeleport.HOUSE_INSIDE, ESpellTeleport.HOUSE_OUTSIDE:
      magicSpell := ERSSpell.TELEPORT_TO_HOUSE;
    ESpellTeleport.KOUREND: magicSpell := ERSSpell.TELEPORT_TO_KOUREND;
    ESpellTeleport.LASSAR: magicSpell := ERSSpell.LASSAR_TELEPORT;
    ESpellTeleport.OURANIA: magicSpell := ERSSpell.OURANIA_TELEPORT;
    ESpellTeleport.RESPAWN: magicSpell := ERSSpell.RESPAWN_TELEPORT;
    ESpellTeleport.VARROCK, ESpellTeleport.GRAND_EXCHANGE:
      magicSpell := ERSSpell.VARROCK_TELEPORT;
    ESpellTeleport.CAMELOT, ESpellTeleport.SEERS:
      magicSpell := ERSSpell.CAMELOT_TELEPORT;
    ESpellTeleport.KHAZARD: magicSpell := ERSSpell.KHAZARD_TELEPORT;
    ESpellTeleport.FALADOR: magicSpell := ERSSpell.FALADOR_TELEPORT;
    ESpellTeleport.BARROWS: magicSpell := ERSSpell.BARROWS_TELEPORT;
    ESpellTeleport.MOONCLAN: magicSpell := ERSSpell.MOONCLAN_TELEPORT;
    ESpellTeleport.CEMETERY: magicSpell := ERSSpell.CEMETERY_TELEPORT;
    ESpellTeleport.GHORROCK: magicSpell := ERSSpell.GHORROCK_TELEPORT;
    ESpellTeleport.ARDOUGNE: magicSpell := ERSSpell.ARDOUGNE_TELEPORT;
    ESpellTeleport.PADDEWWA: magicSpell := ERSSpell.PADDEWWA_TELEPORT;
    ESpellTeleport.KHARYRLL: magicSpell := ERSSpell.KHARYRLL_TELEPORT;
    ESpellTeleport.ANNAKARL: magicSpell := ERSSpell.ANNAKARL_TELEPORT;
    ESpellTeleport.CATHERBY: magicSpell := ERSSpell.CATHERBY_TELEPORT;
    ESpellTeleport.APE_ATOLL_DUNGEON:
      magicSpell := ERSSpell.APE_ATOLL_DUNGEON_TELEPORT;
    ESpellTeleport.LUMBRIDGE: magicSpell := ERSSpell.LUMBRIDGE_TELEPORT;
    ESpellTeleport.BARBARIAN: magicSpell := ERSSpell.BARBARIAN_TELEPORT;
    ESpellTeleport.APE_ATOLL: magicSpell := ERSSpell.APE_ATOLL_TELEPORT;
    ESpellTeleport.TROLLHEIM: magicSpell := ERSSpell.TROLLHEIM_TELEPORT;
    ESpellTeleport.MIND_ALTAR: magicSpell := ERSSpell.MIND_ALTAR_TELEPORT;
    ESpellTeleport.WATCHTOWER, ESpellTeleport.YANILLE:
      magicSpell := ERSSpell.WATCHTOWER_TELEPORT;
    ESpellTeleport.ICE_PLATEU: magicSpell := ERSSpell.ICE_PLATEU_TELEPORT;
    ESpellTeleport.LUNAR_HOME: magicSpell := ERSSpell.LUNAR_HOME_TELEPORT;
    ESpellTeleport.FENKENSTRAINS_CASTLE:
      magicSpell := ERSSpell.FENKENSTRAINS_CASTLE_TELEPORT;
    ESpellTeleport.SALVE_GRAVEYARD:
      magicSpell := ERSSpell.SALVE_GRAVEYARD_TELEPORT;
    ESpellTeleport.ARCEUUS_LIBRARY:
      magicSpell := ERSSpell.ARCEUUS_LIBRARY_TELEPORT;
    ESpellTeleport.HARMONY_ISLAND:
      magicSpell := ERSSpell.HARMONY_ISLAND_TELEPORT;
    ESpellTeleport.EDGEVILLE_HOME:
      magicSpell := ERSSpell.EDGEVILLE_HOME_TELEPORT;
    ESpellTeleport.DRAYNOR_MANOR: magicSpell := ERSSpell.DRAYNOR_MANOR_TELEPORT;
    ESpellTeleport.FISHING_GUILD: magicSpell := ERSSpell.FISHING_GUILD_TELEPORT;
    ESpellTeleport.LUMBRIDGE_HOME:
      magicSpell := ERSSpell.LUMBRIDGE_HOME_TELEPORT;
    ESpellTeleport.WEST_ARDOUGNE: magicSpell := ERSSpell.WEST_ARDOUGNE_TELEPORT;
    ESpellTeleport.CARRALLANGAR: magicSpell := ERSSpell.CARRALLANGAR_TELEPORT;
    ESpellTeleport.ARCEUUS_HOME: magicSpell := ERSSpell.ARCEUUS_HOME_TELEPORT;
    ESpellTeleport.WATERBIRTH: magicSpell := ERSSpell.WATERBIRTH_TELEPORT;
    ESpellTeleport.SENNTISTEN: magicSpell := ERSSpell.SENNTISTEN_TELEPORT;
  end;

  case spell of
    ESpellTeleport.HOUSE_OUTSIDE: option:= 'Outside';
    ESpellTeleport.GRAND_EXCHANGE: option:= 'Grand Exchange';
    ESpellTeleport.SEERS: option:= 'Seers';
    ESpellTeleport.YANILLE: option:= 'Yanille';
    else option:= 'Cast';
  end;

  if Magic.Cast(magicSpell, option) then
    if SleepUntil(pos().InRange(TELEPORT_COORDINATES[spell], 30), 300, t) then
    begin
      Biometrics.Sleep(0, 4*TICK);
      Exit(True);
    end;
end;

{$H-}
var
(*
## Transporter variable
Global {ref}`TTransporter` variable.
*)
  Transporter: TTransporter;
{$H+}

